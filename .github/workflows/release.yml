name: Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.0.0). If not provided, will use latest tag or current commit.'
        required: false
        type: string
      draft:
        description: 'Create as draft release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write
  attestations: write

env:
  CGO_ENABLED: 0

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set build variables
        id: vars
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ inputs.tag }}" ]; then
              version="${{ inputs.tag }}"
            else
              # Use latest tag or fallback to commit SHA
              version=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0-${GITHUB_SHA::8}")
            fi
          else
            # For tag pushes
            version=${GITHUB_REF#refs/tags/}
          fi

          echo "version=$version" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "Using version: $version"

      - name: Release extension
        uses: cli/gh-extension-precompile@v2
        with:
          go_version: '1.23'
          go_build_options: '-ldflags="-w -s -X main.version=${{ steps.vars.outputs.version }} -X main.buildDate=${{ steps.vars.outputs.build_date }}"'
          generate_attestations: true
          release_tag: ${{ steps.vars.outputs.version }}
          draft_release: ${{ github.event_name == 'workflow_dispatch' && inputs.draft || false }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
