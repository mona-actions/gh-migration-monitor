name: Integration Test

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

jobs:
  test-extension:
    name: Test GitHub CLI Extension
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Install GitHub CLI (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh

      - name: Install GitHub CLI (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install gh

      - name: Install GitHub CLI (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          winget install --id GitHub.cli

      - name: Build extension
        run: go build -o gh-migration-monitor .

      - name: Test extension help
        run: ./gh-migration-monitor --help

      - name: Test extension version info
        run: ./gh-migration-monitor --version || echo "Version flag not implemented yet"

      - name: Test extension with invalid flags (should fail gracefully)
        run: |
          if ./gh-migration-monitor --invalid-flag; then
            echo "ERROR: Extension should have failed with invalid flag"
            exit 1
          else
            echo "SUCCESS: Extension properly handled invalid flag"
          fi
        shell: bash
